---
layout: post
category: "BlockChain"
title: "btc铸币交易解析"
tags: [BTC, BlockChain, coinbase]
---

## 1. 交易

### 1.1 区块内交易输入通用格式

| Field                     | Description                                                           | Size                           |
| ------------------------- | --------------------------------------------------------------------- | ------------------------------ |
| Previous Transaction hash | doubled SHA256-hashed of a (previous) to-be-used transaction          | 32 bytes                       |
| Previous Txout-index      | non negative integer indexing an output of the to-be-used transaction | 4 bytes                        |
| Txin-script length        | non negative integer VI = VarInt                                      | 1 - 9 bytes                    |
| Txin-script / scriptSig   | Script                                                                | \<in-script length>-many bytes |
| sequence_no               | normally 0xFFFFFFFF; irrelevant unless transaction's lock_time is > 0 | 4 bytes                        |

### 1.2 区块内交易输出通用格式

| Field                       | Description                                                                   | Size                            |
| --------------------------- | ----------------------------------------------------------------------------- | ------------------------------- |
| value                       | non negative integer giving the number of Satoshis(BTC/10^8) to be transfered | 8 bytes                         |
| Txout-script length         | non negative integer                                                          | 1 - 9 bytes VI = VarInt         |
| Txout-script / scriptPubKey | Script                                                                        | \<out-script length>-many bytes |

[参考链接](https://en.bitcoin.it/wiki/Transaction#Data)

## 2. 举例

### 2.1 创世区块 Raw Data

0100000000000000000000000000000000000000000000000000000000000000000000003ba3edfd7a7b12b27ac72c3e67768f617fc81bc3888a51323a9fb8aa4b1e5e4a29ab5f49ffff001d1dac2b7c0101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff4d04ffff001d0104455468652054696d65732030332f4a616e2f32303039204368616e63656c6c6f72206f6e206272696e6b206f66207365636f6e64206261696c6f757420666f722062616e6b73ffffffff0100f2052a01000000434104678afdb0fe5548271967f1a67130b7105cd6a828e03909a67962e0ea1f61deb649f6bc3f4cef38c4f35504e51ec112de5c384df7ba0b8d578a4c702b6bf11d5fac00000000

[查看 HEX](https://blockchain.info/rawblock/000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f?format=hex)

[查看 JSON](https://blockchain.info/rawblock/000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f?format=json)

#### 2.1.1 Raw Data 拆分

```shell
# version
01000000
# prev block
0000000000000000000000000000000000000000000000000000000000000000
# merkcle root hash
# 4a5e1e4baab89f3a32518a88c31bc87f618f76673e2cc77ab2127b7afdeda33b
3BA3EDFD7A7B12B27AC72C3E67768F617FC81BC3888A51323A9FB8AA4B1E5E4A
# timestamp => 0x495fab29 = 1231006505
29AB5F49
# bits => 0x1d00ffff = 486,604,799
FFFF001D
# nonce => 0x7c2bac1d = 2,083,236,893
1DAC2B7C
# number of transaction
01

# The following Raw Transaction
# The following Raw Transaction
# The following Raw Transaction

# version
01000000
# number of transaction inputs
01
# outpoint txid - fake transaction ID for coinbase transaction
0000000000000000000000000000000000000000000000000000000000000000
# outpoint index - fake index
FFFFFFFF
# script length = 0x4D = 77 bytes (04ffff...E6B73)
4D
# coinbase - any data entered by the miner
04FFFF001D0104455468652054696D65732030332F4A616E2F32303039204368616E63656C6C6F72206F6E206272696E6B206F66207365636F6E64206261696C6F757420666F722062616E6B73
# sequence
FFFFFFFF
# number of transaction outputs
01
# Amount of the first output in little-endian integer
# 0x012A05F200 = 5000000000 Satoshis = 50 BTC
00F2052A01000000
# script length = 0x43 = 67 bytes (434104...1d5fac)
43
# public key script
4104678afdb0fe5548271967f1a67130b7105cd6a828e03909a67962e0ea1f61deb649f6bc3f4cef38c4f35504e51ec112de5c384df7ba0b8d578a4c702b6bf11d5fac
# lock time
00000000
```

#### 2.1.2 Coinbase 解析

Coinbase域可以当作extra nonce增大POW方法的范围。矿工可以通过修改nonce(4 bytes), timestamp(微调) 和extra nonce(2到100bytes)来解题。

04FFFF001D0104455468652054696D65732030332F4A616E2F32303039204368616E63656C6C6F72206F6E206272696E6B206F66207365636F6E64206261696C6F757420666F722062616E6B73

```shell
# 8 bytes for extra nonce ???
04FFFF001D010445
```

```js
function hex_to_ascii(str1) {
    var hex = str1.toString();
    var str = '';
    for (var n = 0; n < hex.length; n += 2) {
        str += String.fromCharCode(parseInt(hex.substr(n, 2), 16));
    }
    return str;
}

const str = '5468652054696D65732030332F4A616E2F32303039204368616E63656C6C6F72206F6E206272696E6B206F66207365636F6E64206261696C6F757420666F722062616E6B73';
console.log(hex_to_ascii(str));
// The Times 03/Jan/2009 Chancellor on brink of second bailout for banks
```

[转换工具](http://string-functions.com/hex-string.aspx)

#### 2.1.3 Public Key Script 解析

4104678afdb0fe5548271967f1a67130b7105cd6a828e03909a67962e0ea1f61deb649f6bc3f4cef38c4f35504e51ec112de5c384df7ba0b8d578a4c702b6bf11d5fac

```shell
# pushes 0x41 = 65 bytes (04678a...f11d5f) onto the stack.
# 0x01-0x4b => The next opcode bytes is data to be pushed onto the stack
41
# pubic key of miner
04678afdb0fe5548271967f1a67130b7105cd6a828e03909a67962e0ea1f61deb649f6bc3f4cef38c4f35504e51ec112de5c384df7ba0b8d578a4c702b6bf11d5f
# OP_CHECKSIG
ac
```

[操作码查询](https://en.bitcoin.it/wiki/Script)

#### 2.1.4 Public Key To Address

CoinBase 中写入了矿工的公钥，因此矿工算出的 target 被盗取了也无用。

```shell
# 1. input
04678afdb0fe5548271967f1a67130b7105cd6a828e03909a67962e0ea1f61deb649f6bc3f4cef38c4f35504e51ec112de5c384df7ba0b8d578a4c702b6bf11d5f
# 2. SHA-256
261C1EB21FC4708C6ACBE1CFC6D4565652E9E768B620782898936B93000A6C02
# 3. RIPEMD-160
62E907B15CBF27D5425399EBF6F0FB50EBB88F18
# 4. Adding network bytes 00
0062E907B15CBF27D5425399EBF6F0FB50EBB88F18
# 5. SHA-256
9B90F16DE7F0E580C07735DAC15FFE23E2F8F8E103914E509AA91913FFDB9FB6
# 6. SHA-256
C29B7D937E3049E279391E62FDF00C12DEF7444013DDF6215808D10E9F2D5996
# 7. First fisrt four bytes
C29B7D93
# 8. 将7的结果拼在4后面
0062E907B15CBF27D5425399EBF6F0FB50EBB88F18C29B7D93
# 9. Base58
1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa
```

[快捷转换工具](http://gobittest.appspot.com/Address)
